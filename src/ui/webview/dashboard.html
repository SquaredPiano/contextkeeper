<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
	<title>Copilot — Dashboard</title>
	<style>
		/* Modern Executive Dashboard Design - Inspired by GitHub Copilot Labs & Vercel */

		* {
			box-sizing: border-box;
		}

		body {
			color: var(--vscode-foreground);
			background: var(--vscode-sideBar-background);
			font-family: var(--vscode-font-family);
			font-size: 13px;
			line-height: 1.6;
			margin: 0;
			padding: 16px;
		}

		/* Card Container - Main visual grouping */
		.card {
			background: var(--vscode-editor-background);
			border: 1px solid var(--vscode-panel-border);
			border-radius: 6px;
			padding: 16px;
			margin-bottom: 16px;
			transition: border-color 0.2s ease, box-shadow 0.2s ease;
		}

		.card:hover {
			border-color: var(--vscode-focusBorder);
		}

		/* Section Headers - Bold, prominent typography */
		.section-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 16px;
			padding-bottom: 12px;
			border-bottom: 2px solid var(--vscode-panel-border);
		}

		.section-title {
			font-size: 15px;
			font-weight: 700;
			color: var(--vscode-editor-foreground);
			letter-spacing: -0.01em;
			margin: 0;
		}

		.section-subtitle {
			font-size: 11px;
			color: var(--vscode-descriptionForeground);
			text-transform: uppercase;
			letter-spacing: 0.05em;
			margin-top: 2px;
		}

		/* Section Header Actions */
		.section-header-actions {
			display: flex;
			gap: 8px;
			align-items: center;
		}

		/* Refresh Button - Responsive design */
		.refresh-btn {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 6px;
			height: 28px;
			padding: 0 10px;
			border: 1px solid var(--vscode-button-border);
			border-radius: 5px;
			background: var(--vscode-button-secondaryBackground);
			color: var(--vscode-button-secondaryForeground);
			font-size: 11px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.15s ease;
			flex-shrink: 0;
		}

		.refresh-btn:hover {
			background: var(--vscode-button-secondaryHoverBackground);
			border-color: var(--vscode-button-hoverBorder);
		}

		.refresh-icon {
			font-size: 12px;
			line-height: 1;
			display: inline-block;
		}

		.refresh-text {
			white-space: nowrap;
		}

		/* Narrow layouts - icon only */
		@media (max-width: 400px) {
			.refresh-btn {
				padding: 0 8px;
				min-width: 28px;
			}

			.refresh-text {
				display: none;
			}

			.refresh-icon {
				margin: 0;
			}
		}

		/* Very narrow layouts - even more compact */
		@media (max-width: 300px) {
			.refresh-btn {
				padding: 0 6px;
				min-width: 24px;
				height: 24px;
			}

			.refresh-icon {
				font-size: 11px;
			}
		}

		/* Collapsible Section Toggle */
		.collapse-toggle {
			background: none;
			border: none;
			color: var(--vscode-descriptionForeground);
			cursor: pointer;
			padding: 6px 10px;
			border-radius: 4px;
			font-size: 11px;
			transition: background-color 0.15s ease, color 0.15s ease;
			display: flex;
			align-items: center;
			gap: 6px;
			font-weight: 500;
			flex-shrink: 0;
			white-space: nowrap;
		}

		.collapse-toggle:hover {
			background: var(--vscode-list-hoverBackground);
			color: var(--vscode-foreground);
		}

		.collapse-toggle-text {
			display: inline-block;
		}

		.collapse-toggle.collapsed .collapse-toggle-text::before {
			content: "Expand";
		}

		.collapse-toggle:not(.collapsed) .collapse-toggle-text::before {
			content: "Collapse";
		}

		.collapsible-content {
			overflow: hidden;
			transition: max-height 0.3s ease, opacity 0.2s ease;
			margin-top: 12px;
		}

		.collapsible-content.collapsed {
			max-height: 0;
			opacity: 0;
			margin: 0;
		}

		/* Responsive content - prevent overflow */
		.collapsible-content > * {
			word-wrap: break-word;
			overflow-wrap: break-word;
			line-height: 1.6;
		}

		/* Info Grid - Clean layout for context data - Responsive */
		.info-grid {
			display: grid;
			grid-template-columns: 1fr;
			gap: 12px;
			margin-bottom: 16px;
		}

		@media (min-width: 300px) {
			.info-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		@media (min-width: 500px) {
			.info-grid {
				grid-template-columns: repeat(3, 1fr);
			}
		}

		@media (min-width: 700px) {
			.info-grid {
				grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
			}
		}

		.info-item {
			display: flex;
			flex-direction: column;
			padding: 12px;
			background: var(--vscode-sideBar-background);
			border: 1px solid var(--vscode-panel-border);
			border-radius: 4px;
		}

		.info-item.summary-item {
			grid-column: 1 / -1;
		}

		.info-label {
			font-size: 10px;
			color: var(--vscode-descriptionForeground);
			text-transform: uppercase;
			letter-spacing: 0.05em;
			margin-bottom: 6px;
			font-weight: 600;
		}

		.info-value {
			font-size: 14px;
			color: var(--vscode-foreground);
			font-weight: 600;
			word-break: break-word;
		}

		.info-value.muted {
			font-size: 12px;
			font-weight: 400;
			color: var(--vscode-descriptionForeground);
			line-height: 1.5;
		}

		/* Stats Grid - Prominent metric display - Responsive */
		.stats-grid {
			display: grid;
			grid-template-columns: 1fr;
			gap: 12px;
			margin: 16px 0;
		}

		@media (min-width: 300px) {
			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		@media (min-width: 500px) {
			.stats-grid {
				grid-template-columns: repeat(3, 1fr);
			}
		}

		.stat-card {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 16px 12px;
			background: var(--vscode-sideBar-background);
			border: 1px solid var(--vscode-panel-border);
			border-radius: 6px;
			text-align: center;
			transition: transform 0.15s ease, border-color 0.15s ease;
		}

		.stat-card:hover {
			transform: translateY(-1px);
			border-color: var(--vscode-focusBorder);
		}

		.stat-label {
			font-size: 11px;
			color: var(--vscode-descriptionForeground);
			text-transform: uppercase;
			letter-spacing: 0.05em;
			margin-bottom: 8px;
			font-weight: 600;
		}

		.stat-value {
			font-size: 20px;
			font-weight: 700;
			color: var(--vscode-foreground);
			line-height: 1.2;
		}

		/* Action Bar - Clean button grouping with improved spacing */
		.action-bar {
			display: flex;
			gap: 10px;
			margin-top: 20px;
			padding-top: 16px;
			border-top: 1px solid var(--vscode-panel-border);
			flex-wrap: wrap;
			align-items: center;
			justify-content: flex-start;
			width: 100%;
			overflow: hidden;
		}

		/* Center align on wide layouts */
		@media (min-width: 600px) {
			.action-bar {
				justify-content: center;
			}
		}

		/* Control Group - Groups related controls together */
		.control-group {
			display: flex;
			align-items: center;
			gap: 10px;
			flex-wrap: wrap;
			flex-shrink: 0;
		}

		/* Toggle Switch Component */
		.toggle-switch {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 8px 14px;
			height: 36px;
			border: 1px solid var(--vscode-panel-border);
			border-radius: 6px;
			background: var(--vscode-sideBar-background);
			cursor: pointer;
			transition: all 0.15s ease;
			white-space: nowrap;
			flex-shrink: 0;
			min-width: 0;
			overflow: hidden;
		}

		.toggle-switch:hover {
			background: var(--vscode-list-hoverBackground);
			border-color: var(--vscode-focusBorder);
		}

		.toggle-label {
			font-size: 12px;
			color: var(--vscode-foreground);
			font-weight: 500;
			margin-right: 4px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			max-width: 100px;
		}

		.toggle-switch-track {
			position: relative;
			width: 44px;
			height: 24px;
			background: var(--vscode-panel-border);
			border-radius: 12px;
			transition: background-color 0.2s ease;
			flex-shrink: 0;
		}

		.toggle-switch-track.active {
			background: var(--vscode-button-background);
		}

		.toggle-switch-thumb {
			position: absolute;
			top: 2px;
			left: 2px;
			width: 20px;
			height: 20px;
			background: var(--vscode-editor-background);
			border-radius: 50%;
			transition: transform 0.2s ease;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
		}

		.toggle-switch-track.active .toggle-switch-thumb {
			transform: translateX(20px);
		}

		/* Action Button - Standard button style */
		.action-btn {
			display: flex;
			align-items: center;
			justify-content: center;
			height: 36px;
			padding: 0 16px;
			border: 1px solid var(--vscode-button-border);
			border-radius: 6px;
			background: var(--vscode-button-secondaryBackground);
			color: var(--vscode-button-secondaryForeground);
			font-size: 12px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.15s ease;
			white-space: nowrap;
			flex-shrink: 0;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.action-btn:hover {
			background: var(--vscode-button-secondaryHoverBackground);
			border-color: var(--vscode-button-hoverBorder);
		}

		.action-btn.primary {
			background: var(--vscode-button-background);
			color: var(--vscode-button-foreground);
		}

		.action-btn.primary:hover {
			background: var(--vscode-button-hoverBackground);
		}

		/* Update Interval Control - Minimal compact design */
		.interval-control {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 6px;
			padding: 8px 12px;
			height: 36px;
			border: 1px solid var(--vscode-panel-border);
			border-radius: 6px;
			background: var(--vscode-sideBar-background);
			flex-shrink: 0;
			cursor: pointer;
			transition: all 0.15s ease;
			position: relative;
		}

		.interval-control:hover {
			background: var(--vscode-list-hoverBackground);
			border-color: var(--vscode-focusBorder);
		}

		.interval-control.editing {
			cursor: default;
			background: var(--vscode-sideBar-background);
		}

		.interval-control.editing:hover {
			background: var(--vscode-sideBar-background);
		}

		.interval-compact {
			display: flex;
			align-items: center;
			gap: 6px;
			flex-shrink: 0;
		}

		.interval-icon {
			font-size: 14px;
			color: var(--vscode-descriptionForeground);
			line-height: 1;
		}

		.interval-display {
			font-size: 12px;
			color: var(--vscode-foreground);
			font-weight: 500;
			white-space: nowrap;
		}

		.interval-input-wrapper {
			display: none;
			align-items: center;
			gap: 4px;
		}

		.interval-control.editing .interval-compact {
			display: none;
		}

		.interval-control.editing .interval-input-wrapper {
			display: flex;
		}

		#autonomyDelayInput {
			width: 50px;
			height: 24px;
			padding: 4px 6px;
			border: 1px solid var(--vscode-input-border);
			border-radius: 4px;
			background: var(--vscode-input-background);
			color: var(--vscode-input-foreground);
			font-size: 12px;
			text-align: center;
			outline: none;
			appearance: none;
			-webkit-appearance: none;
			-moz-appearance: textfield;
			transition: border-color 0.15s ease;
		}

		#autonomyDelayInput:focus {
			border-color: var(--vscode-focusBorder);
			background: var(--vscode-input-background);
		}

		/* Prevent white flash on input */
		#autonomyDelayInput,
		#autonomyDelayInput:focus,
		#autonomyDelayInput:hover {
			background-color: var(--vscode-input-background) !important;
		}

		#autonomyDelayInput::-webkit-outer-spin-button,
		#autonomyDelayInput::-webkit-inner-spin-button {
			-webkit-appearance: none;
			margin: 0;
		}

		.interval-unit {
			font-size: 11px;
			color: var(--vscode-descriptionForeground);
			font-weight: 500;
		}

		/* Issues List - Clean, readable issue display */
		.issues-list {
			margin-top: 0;
		}

		.issue-item {
			padding: 10px 12px;
			margin-bottom: 6px;
			background: var(--vscode-sideBar-background);
			border-left: 3px solid var(--vscode-panel-border);
			border-radius: 4px;
			transition: background-color 0.15s ease, border-color 0.15s ease;
			word-wrap: break-word;
			overflow-wrap: break-word;
			line-height: 1.5;
		}

		.issue-item:hover {
			background: var(--vscode-list-hoverBackground);
		}

		.issue-item:last-child {
			margin-bottom: 0;
		}

		.issue-item.error {
			border-left-color: var(--vscode-editorError-foreground);
		}

		.issue-item.warning {
			border-left-color: var(--vscode-editorWarning-foreground);
		}

		.issue-item.info {
			border-left-color: var(--vscode-editorInfo-foreground);
		}

		.issue-severity {
			display: inline-block;
			font-size: 10px;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			margin-right: 10px;
			padding: 2px 6px;
			border-radius: 3px;
			background: var(--vscode-panel-border);
			color: var(--vscode-foreground);
		}

		.issue-message {
			font-size: 12px;
			color: var(--vscode-foreground);
			line-height: 1.5;
			word-wrap: break-word;
			overflow-wrap: break-word;
		}

		/* Risk Meter - Visual risk indicator */
		.risk-meter {
			display: flex;
			align-items: center;
			gap: 12px;
			margin: 16px 0;
			padding: 12px;
			background: var(--vscode-sideBar-background);
			border-radius: 4px;
		}

		.risk-label {
			font-size: 11px;
			color: var(--vscode-descriptionForeground);
			text-transform: uppercase;
			letter-spacing: 0.05em;
			font-weight: 600;
			min-width: 40px;
		}

		.risk-value {
			font-size: 16px;
			font-weight: 700;
			min-width: 50px;
		}

		.risk-bar-container {
			flex: 1;
			height: 8px;
			background: var(--vscode-panel-border);
			border-radius: 4px;
			overflow: hidden;
		}

		.risk-bar-fill {
			height: 100%;
			width: 0%;
			background: #28a745;
			border-radius: 4px;
			transition: width 0.3s ease, background 0.3s ease;
		}

		/* Count Inline - Clean text display */
		.count-inline {
			display: inline;
			font-weight: 400;
			color: var(--vscode-descriptionForeground);
			margin-left: 6px;
		}

		/* Empty State */
		.empty-state {
			padding: 24px;
			text-align: center;
			color: var(--vscode-descriptionForeground);
			font-size: 12px;
		}

		/* Branch Item - Enhanced styling with responsive layout */
		.branch-item {
			padding: 12px;
			margin-bottom: 8px;
			background: var(--vscode-sideBar-background);
			border: 1px solid var(--vscode-panel-border);
			border-radius: 4px;
			transition: all 0.15s ease;
			word-wrap: break-word;
			overflow-wrap: break-word;
		}

		.branch-item:hover {
			background: var(--vscode-list-hoverBackground);
			border-color: var(--vscode-focusBorder);
		}

		.branch-item:last-child {
			margin-bottom: 0;
		}

		.branch-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 8px;
			gap: 8px;
			flex-wrap: wrap;
			overflow: hidden;
		}

		.branch-name {
			font-size: 13px;
			font-weight: 600;
			color: var(--vscode-foreground);
		}

		.branch-actions {
			display: flex;
			gap: 6px;
			flex-shrink: 0;
			flex-wrap: wrap;
			margin-left: auto;
		}

		.branch-btn {
			padding: 4px 10px;
			font-size: 11px;
			height: 26px;
			flex-shrink: 0;
			white-space: nowrap;
			min-width: fit-content;
		}

		/* Responsive branch actions */
		@media (max-width: 400px) {
			.branch-header {
				flex-direction: column;
				align-items: flex-start;
			}

			.branch-actions {
				margin-left: 0;
				width: 100%;
				margin-top: 8px;
			}

			.branch-btn {
				flex: 1 1 0;
				min-width: 0;
				font-size: 10px;
				padding: 4px 8px;
			}
		}

		.branch-meta {
			font-size: 11px;
			color: var(--vscode-descriptionForeground);
			line-height: 1.6;
			word-wrap: break-word;
			overflow-wrap: break-word;
			margin-top: 4px;
		}

		.branch-current {
			display: inline-block;
			padding: 2px 6px;
			background: var(--vscode-button-background);
			color: var(--vscode-button-foreground);
			border-radius: 3px;
			font-size: 10px;
			font-weight: 600;
			margin-right: 8px;
		}

		/* Change Item */
		.change-item {
			padding: 10px 12px;
			margin-bottom: 6px;
			background: var(--vscode-sideBar-background);
			border-left: 3px solid var(--vscode-panel-border);
			border-radius: 4px;
			word-wrap: break-word;
			overflow-wrap: break-word;
			line-height: 1.5;
		}

		.change-item:last-child {
			margin-bottom: 0;
		}

		.change-actor {
			display: inline-block;
			font-size: 10px;
			color: var(--vscode-descriptionForeground);
			text-transform: uppercase;
			letter-spacing: 0.05em;
			margin-right: 8px;
			font-weight: 600;
		}

		.change-description {
			font-size: 12px;
			color: var(--vscode-foreground);
			font-weight: 500;
			margin: 4px 0;
			word-wrap: break-word;
			overflow-wrap: break-word;
			line-height: 1.5;
		}

		.change-time {
			font-size: 11px;
			color: var(--vscode-descriptionForeground);
			margin-top: 4px;
		}

		/* Responsive Design - Enhanced breakpoints */
		@media (max-width: 300px) {
			.stats-grid {
				grid-template-columns: 1fr;
			}

			.info-grid {
				grid-template-columns: 1fr;
			}

			.action-bar {
				flex-direction: column;
				align-items: stretch;
			}

			.control-group {
				width: 100%;
				flex-direction: column;
			}

			.action-btn,
			.toggle-switch,
			.interval-control {
				width: 100%;
				justify-content: space-between;
			}
		}

		@media (min-width: 300px) and (max-width: 499px) {
			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		@media (min-width: 500px) {
			.stats-grid {
				grid-template-columns: repeat(3, 1fr);
			}
		}

		/* Prevent overflow on all elements */
		.card {
			overflow: hidden;
		}

		.action-bar > * {
			max-width: 100%;
			box-sizing: border-box;
		}
	</style>
</head>
<body>

	<!-- Developer Context Card -->
	<div class="card" id="contextSection">
		<div class="section-header">
			<div>
				<h2 class="section-title">Developer Context</h2>
				<div class="section-subtitle">Current workspace state</div>
			</div>
			</div>

		<div class="info-grid">
			<div class="info-item">
				<div class="info-label">Active File</div>
				<div class="info-value" id="activeFile">-</div>
			</div>
			<div class="info-item">
				<div class="info-label">Branch</div>
				<div class="info-value" id="currentBranch">-</div>
			</div>
			<div class="info-item">
				<div class="info-label">Cursor Line</div>
				<div class="info-value" id="lastLine">-</div>
			</div>
			</div>

		<div class="info-item summary-item">
			<div class="info-label">Summary</div>
			<div class="info-value muted" id="analysisSummary">No summary yet.</div>
			</div>

		<div class="stats-grid">
			<div class="stat-card" title="Total number of edits made in the current session">
				<div class="stat-label">Session Edits</div>
				<div class="stat-value" id="totalEdits">0</div>
			</div>
			<div class="stat-card">
				<div class="stat-label">Files</div>
				<div class="stat-value" id="filesEdited">0</div>
				</div>
			<div class="stat-card">
				<div class="stat-label">Uncommitted</div>
				<div class="stat-value" id="uncommittedChanges">0</div>
				</div>
			</div>

		<div class="action-bar">
			<button id="refreshContextBtn" class="action-btn">Refresh</button>
			
			<div class="control-group">
				<button id="toggleSoundBtn" class="toggle-switch" role="switch" aria-checked="true">
					<span class="toggle-label">Sound</span>
					<div class="toggle-switch-track active" id="soundTrack">
						<div class="toggle-switch-thumb"></div>
					</div>
				</button>
				
				<button id="toggleNotifBtn" class="toggle-switch" role="switch" aria-checked="true">
					<span class="toggle-label">Notifications</span>
					<div class="toggle-switch-track active" id="notifTrack">
						<div class="toggle-switch-thumb"></div>
					</div>
				</button>
			</div>

			<div class="interval-control" title="Update interval in seconds" id="intervalControl">
				<div class="interval-compact">
					<span class="interval-icon">⏱</span>
					<span class="interval-display" id="autonomyDelayDisplay">15s</span>
				</div>
				<div class="interval-input-wrapper">
					<input id="autonomyDelayInput" type="number" min="0" step="1" aria-label="Autonomy delay in seconds" title="Seconds until autonomy starts" />
					<span class="interval-unit">s</span>
				</div>
			</div>
		</div>
	</div>

	<!-- Issues Card -->
	<div class="card" id="issuesSection">
		<div class="section-header">
			<div>
				<h2 class="section-title">
					Issues Found<span class="count-inline" id="issuesCount">(0)</span>
				</h2>
				<div class="section-subtitle">Code analysis results</div>
			</div>
			<button class="collapse-toggle" id="issuesToggle">
				<span class="collapse-toggle-text"></span>
			</button>
		</div>

		<div class="risk-meter">
			<div class="risk-label">Risk</div>
			<div class="risk-value" id="riskNumber">0/10</div>
			<div class="risk-bar-container">
				<div class="risk-bar-fill" id="riskFill"></div>
			</div>
			</div>

		<div class="collapsible-content" id="issuesContent">
			<div id="issuesContainer" class="issues-list">
				<div class="empty-state">No issues found.</div>
			</div>
		</div>
		</div>
		
	<!-- Recent Changes Card -->
	<div class="card" id="extensionChangesSection">
		<div class="section-header">
			<div>
				<h2 class="section-title">
					Recent Changes<span class="count-inline" id="extensionChangesCount">(0)</span>
				</h2>
			</div>
			<button class="collapse-toggle" id="changesToggle">
				<span class="collapse-toggle-text"></span>
			</button>
	</div>

		<div class="collapsible-content" id="changesContent">
			<div id="extensionChangesContainer">
				<div class="empty-state">No recorded changes.</div>
			</div>
		</div>
	</div>

	<!-- Copilot Branches Card -->
	<div class="card" id="copilotBranchesSection">
		<div class="section-header">
			<div>
				<h2 class="section-title">
					Copilot Branches<span class="count-inline" id="copilotBranchesCount">(0)</span>
				</h2>
			</div>
			<button class="collapse-toggle" id="branchesToggle">
				<span class="collapse-toggle-text"></span>
			</button>
		</div>

		<div class="collapsible-content" id="branchesContent">
			<div id="copilotBranchesContainer">
				<div class="empty-state">No copilot branches found.</div>
			</div>
		</div>
	</div>

	<script>
		const vscode = acquireVsCodeApi();

		const ids = ['activeFile','currentBranch','lastLine','analysisSummary','totalEdits','filesEdited','uncommittedChanges','refreshContextBtn','toggleSoundBtn','toggleNotifBtn','issuesCount','riskNumber','riskFill'];
		const el = {};
		ids.forEach(id => el[id] = document.getElementById(id));
		const issuesContainerEl = document.getElementById('issuesContainer');
		const extensionChangesContainer = document.getElementById('extensionChangesContainer');
		const copilotBranchesContainer = document.getElementById('copilotBranchesContainer');

		// Collapsible sections
		function setupCollapsible(toggleId, contentId) {
			const toggle = document.getElementById(toggleId);
			const content = document.getElementById(contentId);
			if (!toggle || !content) return;

			// Initialize as expanded (not collapsed)
			toggle.classList.remove('collapsed');
			content.classList.remove('collapsed');

			toggle.addEventListener('click', () => {
				const isCollapsed = toggle.classList.contains('collapsed');
				toggle.classList.toggle('collapsed', !isCollapsed);
				content.classList.toggle('collapsed', !isCollapsed);
			});
		}

		setupCollapsible('issuesToggle', 'issuesContent');
		setupCollapsible('changesToggle', 'changesContent');
		setupCollapsible('branchesToggle', 'branchesContent');

		// Buttons
		el.refreshContextBtn.addEventListener('click', () => {
			vscode.postMessage({ type: 'requestContext' });
		});

		// Sound toggle
		const SOUND_KEY = 'elevenVoiceEnabled';
		function setSoundUI(enabled) {
			const trackEl = document.getElementById('soundTrack');
			const btnEl = document.getElementById('toggleSoundBtn');
			if (trackEl) {
				trackEl.classList.toggle('active', enabled);
			}
			if (btnEl) {
				btnEl.setAttribute('aria-checked', enabled);
			}
		}

		// Notifications toggle
		const NOTIF_KEY = 'copilotNotifsEnabled';
		function setNotifUI(enabled){
			const trackEl = document.getElementById('notifTrack');
			const btnEl = document.getElementById('toggleNotifBtn');
			if (trackEl) {
				trackEl.classList.toggle('active', enabled);
			}
			if (btnEl) {
				btnEl.setAttribute('aria-checked', enabled);
			}
		}

		// Autonomy delay input - minimal compact design
		const AUTONOMY_KEY = 'autonomyDelay';
		const autonomyInput = document.getElementById('autonomyDelayInput');
		const autonomyDisplay = document.getElementById('autonomyDelayDisplay');
		const intervalControl = document.getElementById('intervalControl');

		function updateAutonomyDisplay(seconds) {
			if (autonomyDisplay) {
				autonomyDisplay.textContent = seconds + 's';
			}
			if (intervalControl) {
				intervalControl.setAttribute('title', `Update interval: ${seconds} seconds`);
			}
		}

		function setAutonomyUI(seconds){
			const val = String(seconds);
			if (autonomyInput) autonomyInput.value = val;
			updateAutonomyDisplay(seconds);
		}

		function sendAutonomyDelay(seconds){
			vscode.postMessage({ type: 'setAutonomyDelay', seconds });
		}

		let _autoTimer = null;
		function scheduleAutoAnalysis(seconds){
			// DISABLED: Auto-analysis timer conflicts with idle detection
			// The idle detector handles autonomous analysis when user is idle
			if (_autoTimer) clearInterval(_autoTimer);
			_autoTimer = null;
			return;
			
			/* OLD CODE - kept for reference
			if (_autoTimer) clearInterval(_autoTimer);
			if (!Number.isFinite(seconds) || seconds <= 0) return;
			_autoTimer = setInterval(()=>{ vscode.postMessage({ type: 'triggerAnalysis' }); }, seconds * 1000);
			*/
		}

		function handleAutonomyChange(value) {
			let v = Number(value);
			if (!Number.isFinite(v) || v < 0) v = 0;
			v = Math.round(v);
			try { localStorage.setItem(AUTONOMY_KEY, String(v)); } catch (e) {}
			setAutonomyUI(v);
			sendAutonomyDelay(v);
			scheduleAutoAnalysis(v);
		}

		function exitEditMode() {
			if (intervalControl) {
				intervalControl.classList.remove('editing');
				if (autonomyInput) {
					autonomyInput.blur();
				}
			}
		}

		try{
			const stored = localStorage.getItem(AUTONOMY_KEY);
			const val = stored === null ? 15 : Number(stored);
			const initial = Number.isFinite(val) ? val : 15;
			setAutonomyUI(initial);
			sendAutonomyDelay(initial);
			scheduleAutoAnalysis(initial);
		} catch(e) { 
			setAutonomyUI(15); 
			sendAutonomyDelay(15); 
			scheduleAutoAnalysis(15); 
		}

		// Click to edit interval
		if (intervalControl) {
			intervalControl.addEventListener('click', (e) => {
				if (!intervalControl.classList.contains('editing')) {
					intervalControl.classList.add('editing');
					if (autonomyInput) {
						setTimeout(() => {
							autonomyInput.focus();
							autonomyInput.select();
						}, 10);
					}
				}
			});
		}

		if (autonomyInput) {
			autonomyInput.addEventListener('change', () => {
				handleAutonomyChange(autonomyInput.value);
				exitEditMode();
			});

			autonomyInput.addEventListener('blur', () => {
				exitEditMode();
			});

			autonomyInput.addEventListener('keydown', (e) => {
				if (e.key === 'Enter') {
					handleAutonomyChange(autonomyInput.value);
					exitEditMode();
				} else if (e.key === 'Escape') {
					exitEditMode();
				}
			});
		}

		document.getElementById('toggleSoundBtn').addEventListener('click', () => {
			let current = null;
			try { current = localStorage.getItem(SOUND_KEY); } catch (e) {}
			const next = current === null ? false : !(current === 'true');
			try { localStorage.setItem(SOUND_KEY, String(next)); } catch (e) {}
			setSoundUI(next);
			vscode.postMessage({ type: 'setElevenVoice', enabled: next });
		});

		document.getElementById('toggleNotifBtn').addEventListener('click', () => {
			let current = null;
			try { current = localStorage.getItem(NOTIF_KEY); } catch (e) {}
			const next = current === null ? false : !(current === 'true');
			try { localStorage.setItem(NOTIF_KEY, String(next)); } catch (e) {}
			setNotifUI(next);
			vscode.postMessage({ type: 'setNotifications', enabled: next });
		});

		// Color interpolation helper
		function lerp(a, b, t) { return a + (b - a) * t; }
		function hexToRgb(hex){ hex = hex.replace('#',''); return [parseInt(hex.slice(0,2),16),parseInt(hex.slice(2,4),16),parseInt(hex.slice(4,6),16)]; }
		function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); }
		function riskColor(value){
			const low = hexToRgb('#28a745');
			const high = hexToRgb('#7a0000');
			const t = Math.max(0, Math.min(1, value/10));
			const r = Math.round(lerp(low[0], high[0], t));
			const g = Math.round(lerp(low[1], high[1], t));
			const b = Math.round(lerp(low[2], high[2], t));
			return rgbToHex(r,g,b);
		}

		// Receive messages from extension
		window.addEventListener('message', e => {
			const msg = e.data;
			if (!msg || !msg.type) return;
			switch (msg.type) {
				case 'contextUpdate': updateContext(msg.payload); break;
				case 'analysisComplete': updateAnalysis(msg.payload); break;
				case 'extensionChanges': updateExtensionChanges(msg.payload); break;
				case 'copilotBranches': updateCopilotBranches(msg.payload); break;
				case 'idleImprovementsComplete': updateIdleImprovements(msg.payload); break;
				case 'notificationsState':
					try { localStorage.setItem(NOTIF_KEY, String(Boolean(msg.enabled))); } catch (e) {}
					setNotifUI(Boolean(msg.enabled));
					break;
				case 'elevenVoiceState':
					try { localStorage.setItem(SOUND_KEY, String(Boolean(msg.enabled))); } catch (e) {}
					setSoundUI(Boolean(msg.enabled));
					break;
				case 'stateChanged':
					break;
			}
		});

		function updateContext(ctx){
			if (el.activeFile) el.activeFile.textContent = (ctx && ctx.files && ctx.files.activeFile) ? ctx.files.activeFile.split('/').pop() : '-';
			if (el.currentBranch) el.currentBranch.textContent = (ctx && ctx.git && ctx.git.currentBranch) ? ctx.git.currentBranch : '-';
			if (el.lastLine) el.lastLine.textContent = (ctx && ctx.cursor && typeof ctx.cursor.line === 'number') ? String(ctx.cursor.line) : '-';
			if (el.totalEdits) el.totalEdits.textContent = String((ctx && ctx.session && ctx.session.totalEdits) ? ctx.session.totalEdits : 0);
			if (el.filesEdited) el.filesEdited.textContent = String((ctx && ctx.files && ctx.files.recentlyEdited) ? ctx.files.recentlyEdited.length : 0);
			if (el.uncommittedChanges) el.uncommittedChanges.textContent = String((ctx && ctx.git && ctx.git.uncommittedChanges) ? ctx.git.uncommittedChanges.length : 0);
		}

		function updateAnalysis(analysis){
			if (el.issuesCount) {
				const count = (analysis && analysis.issues) ? analysis.issues.length : 0;
				el.issuesCount.textContent = `(${count})`;
			}
			const summary = (analysis && analysis.summary) ? analysis.summary
				: (analysis && analysis.suggestions && analysis.suggestions.length>0) ? analysis.suggestions.slice(0,2).map(s=>s.message).join(' ') 
				: (analysis && analysis.issues && analysis.issues.length>0) ? `Found ${analysis.issues.length} issues; top: ${analysis.issues[0].message}` 
				: 'Analysis complete.';
			if (el.analysisSummary) el.analysisSummary.textContent = summary;

			// Determine numeric risk 0-10
			let riskVal = 0;
			if (analysis && typeof analysis.risk === 'number') {
				riskVal = Math.max(0, Math.min(10, Math.round(analysis.risk)));
			} else if (analysis && typeof analysis.riskLevel === 'number') {
				riskVal = Math.max(0, Math.min(10, Math.round(analysis.riskLevel)));
			} else if (analysis && typeof analysis.riskLevel === 'string') {
				const s = analysis.riskLevel.toLowerCase();
				if (s === 'low') riskVal = 2; else if (s === 'medium') riskVal = 5; else if (s === 'high') riskVal = 8; else riskVal = 0;
			}

			const color = riskColor(riskVal);
			const rn = document.getElementById('riskNumber');
			const rf = document.getElementById('riskFill');
			if (rn) {
				rn.textContent = `${riskVal}/10`;
				rn.style.color = color;
			}
			if (rf) { 
				rf.style.width = `${(riskVal/10)*100}%`; 
				rf.style.background = color; 
			}

			if (analysis && analysis.issues && analysis.issues.length>0){
				if (issuesContainerEl) {
					issuesContainerEl.innerHTML = analysis.issues.slice(0,8).map(i => {
						const severityClass = i.severity || 'info';
						return `<div class="issue-item ${severityClass}">
							<span class="issue-severity">${severityClass.toUpperCase()}</span>
							<span class="issue-message">${i.message}</span>
						</div>`;
					}).join('');
				}
			} else {
				if (issuesContainerEl) issuesContainerEl.innerHTML = '<div class="empty-state">No issues found.</div>';
			}
		}

		function updateExtensionChanges(changes){
			const countEl = document.getElementById('extensionChangesCount');
			if (!extensionChangesContainer) return;
			if (!changes || !Array.isArray(changes) || changes.length === 0){
				if (countEl) countEl.textContent = '(0)';
				extensionChangesContainer.innerHTML = '<div class="empty-state">No recorded changes.</div>';
				return;
			}
			if (countEl) countEl.textContent = `(${changes.length})`;
			extensionChangesContainer.innerHTML = changes.slice(0,50).map(c => {
				const time = c.time ? (new Date(c.time)).toLocaleString() : '';
				const what = c.description || c.message || c.action || JSON.stringify(c);
				const who = c.actor ? `<span class="change-actor">${c.actor}</span>` : '';
				return `<div class="change-item">
					${who}
					<div class="change-description">${what}</div>
					<div class="change-time">${time}</div>
				</div>`;
			}).join('');
		}

		function updateIdleImprovements(payload){
			if (!payload) return;
			
			const summary = payload.summary || 'Completed idle analysis';
			const testsCount = payload.testsGenerated || 0;
			const recommendations = payload.recommendations || [];
			
			const summaryEl = document.getElementById('analysisSummary');
			if (summaryEl) {
				summaryEl.textContent = `While you were away: ${summary}`;
			}
			
			const changes = [];
			changes.push({
				time: payload.timestamp || Date.now(),
				description: `Idle Analysis: ${summary}`,
				actor: 'autonomous',
				action: 'idle-analysis'
			});
			
			if (testsCount > 0) {
				changes.push({
					time: payload.timestamp || Date.now(),
					description: `Generated ${testsCount} test file(s)`,
					actor: 'autonomous',
					action: 'test-generation'
				});
			}
			
			recommendations.slice(0, 5).forEach(rec => {
				changes.push({
					time: payload.timestamp || Date.now(),
					description: `[${rec.priority.toUpperCase()}] ${rec.message}`,
					actor: 'autonomous',
					action: 'recommendation'
				});
			});
			
			const existingChanges = JSON.parse(localStorage.getItem('extensionChanges') || '[]');
			const merged = [...changes, ...existingChanges].slice(0, 100);
			try {
				localStorage.setItem('extensionChanges', JSON.stringify(merged));
			} catch (e) {}
			
			updateExtensionChanges(merged);
		}

		function updateCopilotBranches(branches){
			const countEl = document.getElementById('copilotBranchesCount');
			if (!copilotBranchesContainer) return;
			if (!branches || !Array.isArray(branches) || branches.length === 0){
				if (countEl) countEl.textContent = '(0)';
				copilotBranchesContainer.innerHTML = '<div class="empty-state">No copilot branches found.</div>';
				return;
			}
			if (countEl) countEl.textContent = `(${branches.length})`;
			
			copilotBranchesContainer.innerHTML = branches.map((b) => {
				const date = b.lastCommitDate ? (new Date(b.lastCommitDate)).toLocaleString() : '';
				const current = b.isCurrent ? '<span class="branch-current">CURRENT</span>' : '';
				const commitMsg = b.lastCommit ? b.lastCommit.substring(0, 60) + (b.lastCommit.length > 60 ? '...' : '') : 'No commits';
				const branchNameEscaped = b.name.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
				return `<div class="branch-item">
					<div class="branch-header">
						<div>
						${current}
							<span class="branch-name">${b.name}</span>
						</div>
						<div class="branch-actions">
							${!b.isCurrent ? `<button class="action-btn branch-btn branch-checkout" data-branch="${branchNameEscaped}" type="button">Checkout</button>` : ''}
							<button class="action-btn branch-btn branch-merge" data-branch="${branchNameEscaped}" type="button">Merge</button>
							<button class="action-btn branch-btn branch-delete" data-branch="${branchNameEscaped}" type="button">Delete</button>
					</div>
					</div>
					<div class="branch-meta">${commitMsg}</div>
					<div class="branch-meta" style="font-size: 10px; margin-top: 4px;">${date}</div>
				</div>`;
			}).join('');
		}

		// Event delegation for branch buttons
		document.addEventListener('click', (e) => {
			const target = e.target;
			if (!target || !target.classList) return;
			
			const button = target.closest('.branch-checkout, .branch-merge, .branch-delete');
			if (!button) return;
			
			const branchName = button.getAttribute('data-branch');
			if (!branchName) return;
			
			const decodedBranchName = branchName.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
			
			if (button.classList.contains('branch-checkout')) {
				vscode.postMessage({ type: 'checkoutCopilotBranch', branchName: decodedBranchName });
			} else if (button.classList.contains('branch-merge')) {
				vscode.postMessage({ type: 'mergeCopilotBranch', branchName: decodedBranchName });
			} else if (button.classList.contains('branch-delete')) {
				vscode.postMessage({ type: 'deleteCopilotBranch', branchName: decodedBranchName });
			}
		});


		// Request initial data
		vscode.postMessage({ type: 'requestContext' });
		vscode.postMessage({ type: 'ensureSoundOn' });
		vscode.postMessage({ type: 'requestCopilotBranches' });

		// Initialize UI
		try { 
			const stored = localStorage.getItem(SOUND_KEY); 
			setSoundUI(stored === null ? true : stored === 'true'); 
		} catch (e) { 
			setSoundUI(true); 
		}
	</script>
</body>
</html>
